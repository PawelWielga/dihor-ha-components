<!doctype html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <title>Custom cards preview</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="index.css" />
    <link rel="stylesheet" href="cards/theme.css" />
    <link rel="stylesheet" href="cards/core.css" />

    <!-- Dodanie czcionki ROBOTO -->
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto&display=swap"
      rel="stylesheet"
    />

    <!-- Dołączenie CSS komponentów -->
    <script>
      const isLocal =
        location.hostname === 'localhost' || location.protocol === 'file:';
      const basePath = isLocal ? '/cards' : './cards';
      const manifestPath = `${basePath}/cards-docs.json`;
      window.__cardsBasePath = basePath;
      window.__cardsManifestPromise = fetch(manifestPath)
        .then((response) => {
          if (!response.ok) {
            throw new Error('Nie udało się pobrać manifestu kart');
          }
          return response.json();
        })
        .catch((error) => {
          console.warn('cards-docs.json fetch failed:', error);
          return [];
        });

      window.__cardsManifestPromise.then((cards) => {
        cards.forEach((card) => {
          if (card.preview && card.preview.css) {
            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = `${basePath}/${card.folder}/${card.preview.css}`;
            document.head.appendChild(link);
          }
        });
      });
    </script>
  </head>

  <body>
    <div class="app-shell">
      <nav class="navbar">
        <div class="navbar-title">đź“¦ Custom Cards Preview</div>
        <div class="navbar-buttons">
          <button id="toggle-language" title="Zmień język">đź‡µđź‡±</button>
          <button id="toggle-theme" title="Zmień motyw">đźŚ™</button>
        </div>
      </nav>

      <main class="split-layout">
        <section class="mock-panel">
          <div class="phone-mock">
            <div class="phone-top">
              <div class="phone-status">
                <span class="phone-signal" aria-hidden="true"></span>
                <span class="phone-time">18:32</span>
                <span class="phone-battery" aria-hidden="true"></span>
              </div>
            </div>
            <div class="phone-screen" role="presentation">
              <div class="phone-inner">
                <div class="phone-app-bar">
                  <div class="phone-app-bar-left">
                    <span class="app-icon hamburger"></span>
                    <span class="app-icon home"></span>
                    <span class="app-icon gear"></span>
                  </div>
                  <div class="phone-app-bar-right">
                    <span class="status-dot"></span>
                  </div>
                </div>
                <p class="phone-app-title">dihor-ha-components (test view)</p>
                <div class="phone-cards" id="phone-cards">
                  <div class="coming-soon-section">
                    <div class="coming-soon-icon">đźš€</div>
                    <div class="coming-soon-text">Kolejne komponenty wkrótce!</div>
                    <div class="coming-soon-subtitle">
                      Pracujemy nad nowymi kartami dla Home Assistant
                    </div>
                  </div>
                </div>
                <div class="phone-home-indicator"></div>
              </div>
            </div>
          </div>
        </section>

        <section class="info-panel">
          <div class="info-card" id="hac-info">
            <div class="info-card-header">
              <h2 id="hacs-title">Zainstaluj przez HACS</h2>
            </div>
            <p id="hacs-description">
              W HACS dodajemy repozytorium frontendu, aby zainstalować komponenty.
            </p>
            <ol id="hacs-steps">
              <li>Otwórz HACS i przejdź do zakładki Frontend.</li>
              <li>
                Dodaj nowe repozytorium <code>https://github.com/dihor/dihor-ha-components</code>.
              </li>
              <li>Wybierz kategorię Frontend, zapisz i zainstaluj.</li>
            </ol>
            <p class="info-note" id="hacs-note">
              Po zainstalowaniu odśwież widok, aby zobaczyć karty po lewej.
            </p>
          </div>

          <div class="info-card yaml-card">
            <div class="info-card-header">
              <h3 id="yaml-title">Konfiguracja YAML</h3>
              <p id="yaml-hint">
                Kliknij kartę po lewej, aby zobaczyć przykładową konfigurację.
              </p>
            </div>
            <pre id="yaml-output">Wybierz kartę, aby zobaczyć YAML.</pre>
          </div>

          <footer class="version-footer">
            <span id="version-label">Wersja</span>: <span id="docs-version">?</span>
          </footer>
        </section>
      </main>
    </div>

    <!-- Wszystko działa tutaj -->
    <script>
      const translations = {
        pl: {
          comingSoon: 'Kolejne komponenty wkrótce!',
          comingSoonSub: 'Pracujemy nad nowymi kartami dla Home Assistant',
          previewLabel: 'Podgląd karty',
          loading: 'Ładowanie podglądu...',
          error: 'Nie udało się załadować podglądu',
          versionLabel: 'Wersja',
          hacsHeader: 'Zainstaluj przez HACS',
          hacsDescription:
            'W HACS dodaj repozytorium frontendu, aby zainstalować komponenty.',
          hacsSteps: [
            'Otwórz HACS i przejdź do zakładki Frontend.',
            'Dodaj repozytorium https://github.com/dihor/dihor-ha-components jako Frontend.',
            'Zainstaluj je i zrestartuj Home Assistanta.',
          ],
          hacsNote: 'Po instalacji odśwież widok, aby zobaczyć karty po lewej.',
          yamlTitle: 'Konfiguracja YAML',
          yamlHint: 'Kliknij kartę po lewej, aby zobaczyć przykładową konfigurację.',
          yamlPlaceholder: 'Wybierz kartę, aby zobaczyć YAML.',
        },
        en: {
          comingSoon: 'More components coming soon!',
          comingSoonSub: "We're working on new Home Assistant cards",
          previewLabel: 'Card preview',
          loading: 'Loading preview...',
          error: 'Failed to load preview',
          versionLabel: 'Version',
          hacsHeader: 'Install via HACS',
          hacsDescription: 'Add the frontend repository in HACS to install our cards.',
          hacsSteps: [
            'Open HACS and switch to the Frontend section.',
            'Add https://github.com/dihor/dihor-ha-components as a custom repository (Frontend).',
            'Install it and refresh Home Assistant.',
          ],
          hacsNote: 'After installation the mock dashboard will show the cards on the left.',
          yamlTitle: 'YAML configuration',
          yamlHint: 'Select a card on the left to preview its sample YAML.',
          yamlPlaceholder: 'Select a card to inspect the YAML.',
        },
      };

      const phoneCardsContainer = document.getElementById('phone-cards');
      const yamlOutputEl = document.getElementById('yaml-output');
      const yamlHintEl = document.getElementById('yaml-hint');
      const yamlTitleEl = document.getElementById('yaml-title');
      const hacsTitleEl = document.getElementById('hacs-title');
      const hacsDescriptionEl = document.getElementById('hacs-description');
      const hacsStepsEl = document.getElementById('hacs-steps');
      const hacsNoteEl = document.getElementById('hacs-note');
      const versionLabelEl = document.getElementById('version-label');

      let currentTheme = localStorage.getItem('theme') || 'light';
      let currentLang = localStorage.getItem('lang') || 'pl';
      let latestCards = [];
      let activeCard = null;

      function applyThemeToCards() {
        const isDark = currentTheme === 'dark';
        document.body.classList.toggle('dark', isDark);
        document.body.classList.toggle('light', !isDark);
        document
          .querySelectorAll('.card-preview .dihor-card')
          .forEach((card) => {
            card.classList.toggle('dihor-theme-dark', isDark);
            card.classList.toggle('dihor-theme-light', !isDark);
          });
      }

      function setupThemeToggle() {
        const themeButton = document.getElementById('toggle-theme');
        if (!themeButton) return;
        themeButton.textContent = currentTheme === 'dark' ? 'â€ď¸Ź' : 'đźŚ™';
        applyThemeToCards();
        themeButton.addEventListener('click', () => {
          currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
          localStorage.setItem('theme', currentTheme);
          themeButton.textContent = currentTheme === 'dark' ? 'â€ď¸Ź' : 'đźŚ™';
          applyThemeToCards();
        });
      }

      function formatYaml(card) {
        if (!card || !card.usage || !card.usage.length) {
          return translations[currentLang].yamlPlaceholder;
        }
        return card.usage
          .map((line) => `${line.key}: ${line.value}`)
          .join('\n');
      }

      function updateYamlOutput(card) {
        if (!yamlOutputEl) return;
        const text = formatYaml(card);
        yamlOutputEl.textContent = text;
      }

      function selectCard(card) {
        if (!card) return;
        const previous = document.querySelector('.phone-card.is-active');
        if (previous) {
          previous.classList.remove('is-active');
        }
        const current = document.querySelector(
          `.phone-card[data-card-id="${card.id}"]`
        );
        if (current) {
          current.classList.add('is-active');
          current.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        activeCard = card;
        updateYamlOutput(card);
      }

      function renderCards(cards) {
        if (!phoneCardsContainer) return;
        latestCards = cards || [];
        phoneCardsContainer
          .querySelectorAll('.phone-card')
          .forEach((node) => node.remove());
        const comingSoon = phoneCardsContainer.querySelector(
          '.coming-soon-section'
        );
        cards.forEach((card) => {
          const cardElement = document.createElement('article');
          cardElement.className = 'phone-card';
          cardElement.setAttribute('data-card-id', card.id);
          cardElement.innerHTML = `
            <div class="phone-card-preview" id="${card.id}-card-preview">
              <div class="loading-placeholder">${translations[currentLang].loading}</div>
            </div>
          `;
          cardElement.addEventListener('click', () => selectCard(card));
          if (comingSoon) {
            phoneCardsContainer.insertBefore(cardElement, comingSoon);
          } else {
            phoneCardsContainer.appendChild(cardElement);
          }
        });
        applyThemeToCards();
      }

      function applyTranslations() {
        const t = translations[currentLang];
        if (hacsTitleEl) {
          hacsTitleEl.textContent = t.hacsHeader;
        }
        if (hacsDescriptionEl) {
          hacsDescriptionEl.textContent = t.hacsDescription;
        }
        if (hacsNoteEl) {
          hacsNoteEl.textContent = t.hacsNote;
        }
        if (yamlTitleEl) {
          yamlTitleEl.textContent = t.yamlTitle;
        }
        if (yamlHintEl) {
          yamlHintEl.textContent = t.yamlHint;
        }
        if (versionLabelEl) {
          versionLabelEl.textContent = t.versionLabel;
        }
        if (hacsStepsEl) {
          hacsStepsEl.innerHTML = '';
          t.hacsSteps.forEach((step) => {
            const li = document.createElement('li');
            li.textContent = step;
            hacsStepsEl.appendChild(li);
          });
        }
        const comingText = document.querySelector('.coming-soon-text');
        if (comingText) {
          comingText.textContent = t.comingSoon;
        }
        const comingSubtitle = document.querySelector(
          '.coming-soon-subtitle'
        );
        if (comingSubtitle) {
          comingSubtitle.textContent = t.comingSoonSub;
        }
        document
          .querySelectorAll('.loading-placeholder')
          .forEach((el) => (el.textContent = '⏳ ' + t.loading));
        updateYamlOutput(activeCard);
      }

      function setupLanguageToggle() {
        const langButton = document.getElementById('toggle-language');
        if (!langButton) return;
        const render = () => applyTranslations();
        langButton.textContent = currentLang === 'pl' ? 'đź‡µđź‡±' : 'đź‡¬đź‡§';
        langButton.addEventListener('click', () => {
          currentLang = currentLang === 'pl' ? 'en' : 'pl';
          localStorage.setItem('lang', currentLang);
          langButton.textContent = currentLang === 'pl' ? 'đź‡µđź‡±' : 'đź‡¬đź‡§';
          render();
        });
        render();
      }

      function loadCardPreview(cards) {
        const previewBasePath = window.__cardsBasePath || './cards';
        cards.forEach((card) => {
          if (!card.folder || !card.preview || !card.preview.html) {
            return;
          }
          const el = document.getElementById(`${card.id}-card-preview`);
          if (!el) {
            return;
          }
          fetch(`${previewBasePath}/${card.folder}/${card.preview.html}`)
            .then((res) => {
              if (!res.ok) {
                throw new Error(res.statusText || 'Błąd HTTP');
              }
              return res.text();
            })
            .then((html) => {
              el.innerHTML = html;
              applyThemeToCards();
            })
            .catch((err) => {
              const localizedError =
                translations[currentLang] &&
                translations[currentLang].error
                  ? `${translations[currentLang].error}: ${err.message}`
                  : err.message;
              el.innerHTML = `<div class="error-placeholder">✖ ${localizedError}</div>`;
            });
        });
      }

      function displayDocsVersion() {
        const versionEl = document.getElementById('docs-version');
        if (!versionEl) return;
        const versionPath = `${window.__cardsBasePath || '.'}/version.json`;
        fetch(versionPath)
          .then((res) => {
            if (!res.ok) {
              throw new Error(res.statusText || 'Failed to load version');
            }
            return res.json();
          })
          .then((info) => {
            versionEl.textContent = info.version || 'n/a';
            if (info.generatedAt) {
              versionEl.setAttribute(
                'title',
                `Generated ${new Date(info.generatedAt).toLocaleString()}`
              );
            }
          })
          .catch(() => {
            versionEl.textContent = 'n/a';
          });
      }

      function resolveManifestPromise() {
        if (window.__cardsManifestPromise) {
          return window.__cardsManifestPromise;
        }
        const fallbackPath = `${window.__cardsBasePath || './cards'}/cards-docs.json`;
        return fetch(fallbackPath)
          .then((response) => {
            if (!response.ok) {
              throw new Error('Manifest build fetch failed');
            }
            return response.json();
          })
          .catch(() => []);
      }

      document.addEventListener('DOMContentLoaded', () => {
        setupThemeToggle();
        displayDocsVersion();
        resolveManifestPromise().then((cards) => {
          if (cards && cards.length) {
            latestCards = cards;
            renderCards(cards);
            loadCardPreview(cards);
            selectCard(cards[0]);
          }
          setupLanguageToggle();
        });
      });
    </script>
    <script src="clock.js"></script>
  </body>
</html>
