<!doctype html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <title>Custom cards preview</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="index.css" />
    <link rel="stylesheet" href="cards/theme.css" />
    <link rel="stylesheet" href="cards/core.css" />

    <!-- Dodanie czcionki ROBOTO -->
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto&display=swap"
      rel="stylesheet"
    />

    <!-- DoÅ‚Ä…czenie CSS komponentÃ³w -->
    <script>
      const isLocal =
        location.hostname === 'localhost' || location.protocol === 'file:';
      const basePath = isLocal ? '/cards' : './cards';
      const manifestPath = `${basePath}/cards-docs.json`;
      window.__cardsBasePath = basePath;
      window.__cardsManifestPromise = fetch(manifestPath)
        .then((response) => {
          if (!response.ok) {
            throw new Error('Nie udaÅ‚o siÄ™ pobraÄ‡ manifestu kart');
          }
          return response.json();
        })
        .catch((error) => {
          console.warn('cards-docs.json fetch failed:', error);
          return [];
        });

      window.__cardsManifestPromise.then((cards) => {
        cards.forEach((card) => {
          if (card.preview && card.preview.css) {
            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = `${basePath}/${card.folder}/${card.preview.css}`;
            document.head.appendChild(link);
          }
        });
      });
    </script>
  </head>

  <body>
    <div class="container">
      <nav class="navbar">
        <div class="navbar-title">ğŸ“¦ Custom Cards Preview</div>
        <div class="navbar-buttons">
          <button id="toggle-language" title="ZmieÅ„ jÄ™zyk">ğŸ‡µğŸ‡±</button>
          <button id="toggle-theme" title="ZmieÅ„ motyw">ğŸŒ™</button>
        </div>
      </nav>

      <div class="cards-grid" id="cards-grid">
        <div class="coming-soon-section">
          <div class="coming-soon-icon">ğŸš€</div>
          <div class="coming-soon-text">Kolejne komponenty wkrÃ³tce!</div>
          <div class="coming-soon-subtitle">
            Pracujemy nad nowymi kartami dla Home Assistant
          </div>
        </div>
      </div>
    </div>
    <footer class="version-footer">
      <span id="version-label">Wersja</span>: <span id="docs-version">?</span>
    </footer>

    <!-- Wszystko dziaÅ‚a tutaj -->
    <script>
      const translations = {
        pl: {
          comingSoon: 'Kolejne komponenty wkrÃ³tce!',
          comingSoonSub: 'Pracujemy nad nowymi kartami dla Home Assistant',
          previewLabel: 'PodglÄ…d karty',
          yamlHeader: 'Konfiguracja YAML',
          loading: 'Åadowanie podglÄ…du...',
          error: 'Nie udaÅ‚o siÄ™ zaÅ‚adowaÄ‡ podglÄ…du',
          versionLabel: 'Wersja',
        },
        en: {
          comingSoon: 'More components coming soon!',
          comingSoonSub: "We're working on new Home Assistant cards",
          previewLabel: 'Card preview',
          yamlHeader: 'YAML Configuration',
          loading: 'Loading preview...',
          error: 'Failed to load preview',
          versionLabel: 'Version',
        },
      };

      const cardsGrid = document.getElementById('cards-grid');

      function applyThemeToCards() {
        const isDark = localStorage.getItem('theme') === 'dark';
        document
          .querySelectorAll('.card-preview .dihor-card')
          .forEach((card) => {
            card.classList.toggle('dihor-theme-dark', isDark);
            card.classList.toggle('dihor-theme-light', !isDark);
          });
      }

      function setupThemeToggle() {
        const themeButton = document.getElementById('toggle-theme');
        let currentTheme = localStorage.getItem('theme') || 'light';
        themeButton.textContent = currentTheme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
        applyThemeToCards();
        themeButton.addEventListener('click', () => {
          currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
          localStorage.setItem('theme', currentTheme);
          themeButton.textContent = currentTheme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
          applyThemeToCards();
        });
      }

      function renderCards(cards) {
        if (!cardsGrid) return;
        const comingSoon = cardsGrid.querySelector('.coming-soon-section');
        cards.forEach((card) => {
          const configLines = (card.usage || [])
            .map(
              (line) => `<div class="config-line">
                <span class="config-key">${line.key}</span>
                <span class="config-separator">:</span>
                <span class="config-value">${line.value}</span>
              </div>`
            )
            .join('');
          const cardElement = document.createElement('div');
          cardElement.className = 'card-showcase';
          cardElement.innerHTML = `
            <div class="card-header">
              <div class="card-icon">${card.icon || 'ğŸ“¦'}</div>
              <div>
                <h3 class="card-title">${card.name}</h3>
                <p class="card-subtitle" data-card-id="${card.id}"></p>
              </div>
            </div>

            <div class="preview-section">
              <div class="preview-label">PodglÄ…d karty</div>
              <div class="card-preview" id="${card.id}-card-preview">
                <div class="loading-placeholder">Åadowanie podglÄ…du...</div>
              </div>
            </div>

            <div class="usage-section">
              <div class="usage-header">Konfiguracja YAML</div>
              <div class="config-lines">
                ${configLines}
              </div>
            </div>
          `;
          if (comingSoon) {
            cardsGrid.insertBefore(cardElement, comingSoon);
          } else {
            cardsGrid.appendChild(cardElement);
          }
        });
        applyThemeToCards();
      }

      function setupLanguageToggle(cards = []) {
        const langButton = document.getElementById('toggle-language');
        let lang = localStorage.getItem('lang') || 'pl';
        langButton.textContent = lang === 'pl' ? 'ğŸ‡µğŸ‡±' : 'ğŸ‡¬ğŸ‡§';

        function applyTranslations() {
          const t = translations[lang];
          cards.forEach((card) => {
            const subtitleEl = document.querySelector(
              `.card-subtitle[data-card-id="${card.id}"]`
            );
            if (subtitleEl) {
              subtitleEl.textContent =
                (card.subtitle && card.subtitle[lang]) ||
                (card.subtitle && card.subtitle.pl) ||
                '';
            }
          });
          const versionLabelEl = document.getElementById('version-label');
          if (versionLabelEl) {
            versionLabelEl.textContent = t.versionLabel || 'Wersja';
          }
          document
            .querySelectorAll('.preview-label')
            .forEach((el) => (el.textContent = t.previewLabel));
          document
            .querySelectorAll('.usage-header')
            .forEach((el) => (el.textContent = t.yamlHeader));
          document.querySelector('.coming-soon-text').textContent =
            t.comingSoon;
          document.querySelector('.coming-soon-subtitle').textContent =
            t.comingSoonSub;
          document
            .querySelectorAll('.loading-placeholder')
            .forEach((el) => (el.textContent = 'â³ ' + t.loading));
        }

        langButton.addEventListener('click', () => {
          lang = lang === 'pl' ? 'en' : 'pl';
          localStorage.setItem('lang', lang);
          langButton.textContent = lang === 'pl' ? 'ğŸ‡µğŸ‡±' : 'ğŸ‡¬ğŸ‡§';
          applyTranslations();
        });

        applyTranslations();
      }

      function loadCardPreview(cards) {
        const previewBasePath = window.__cardsBasePath || './cards';
        cards.forEach((card) => {
          if (!card.folder || !card.preview || !card.preview.html) {
            return;
          }
          const el = document.getElementById(`${card.id}-card-preview`);
          if (!el) {
            return;
          }
          fetch(`${previewBasePath}/${card.folder}/${card.preview.html}`)
            .then((res) => {
              if (!res.ok) {
                throw new Error(res.statusText || 'BÅ‚Ä…d HTTP');
              }
              return res.text();
            })
            .then((html) => {
              el.innerHTML = html;
              applyThemeToCards();
            })
            .catch((err) => {
              el.innerHTML = `<div class="error-placeholder">âŒ BÅ‚Ä…d: ${err.message}</div>`;
            });
        });
      }

      function displayDocsVersion() {
        const versionEl = document.getElementById('docs-version');
        if (!versionEl) return;
        fetch('./version.json')
          .then((res) => {
            if (!res.ok) {
              throw new Error(res.statusText || 'Failed to load version');
            }
            return res.json();
          })
          .then((info) => {
            versionEl.textContent = info.version || 'n/a';
            if (info.generatedAt) {
              versionEl.setAttribute(
                'title',
                `Generated ${new Date(info.generatedAt).toLocaleString()}`
              );
            }
          })
          .catch(() => {
            versionEl.textContent = 'n/a';
          });
      }

      function resolveManifestPromise() {
        if (window.__cardsManifestPromise) {
          return window.__cardsManifestPromise;
        }
        const fallbackPath = `${window.__cardsBasePath || './cards'}/cards-docs.json`;
        return fetch(fallbackPath)
          .then((response) => {
            if (!response.ok) {
              throw new Error('Manifest build fetch failed');
            }
            return response.json();
          })
          .catch(() => []);
      }

      document.addEventListener('DOMContentLoaded', () => {
        setupThemeToggle();
        displayDocsVersion();
        resolveManifestPromise().then((cards) => {
          if (cards && cards.length) {
            renderCards(cards);
            loadCardPreview(cards);
          }
          setupLanguageToggle(cards);
        });
      });
    </script>
    <script src="clock.js"></script>
  </body>
</html>
